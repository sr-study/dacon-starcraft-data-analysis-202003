import numpy as np

from .extract_game_states import GameState


class AbilityCounts(GameState):
    abilities = ['(1360) - TrainSCV', '(1021) - BuildSupplyDepot', '(480) - Stop', '(1022) - BuildRefinery', '(1023) - BuildBarracks', '(1020) - BuildCommandCenter', '(13E0) - TrainMarine', '(1C60) - UpgradeToOrbitalCommand', '(102A) - BuildFactory', '(5A0) - Attack', '(1261) - BuildBarracksReactor', '(E20) - ExtraSupplies', '(12A0) - BuildFactoryTechLab', '(4E40) - KD8Charge', '(1000) - SCVRepair', '(1401) - BuildSiegeTank', '(102B) - BuildStarport', '(1024) - BuildEngineeringBay', '(1418) - BuildWidowMine', '(10E0) - SiegeMode', '(1420) - TrainMedivac', '(1446) - UpgradeTerranInfantryArmor1', '(F61) - CancelSlot', '(B40) - CalldownMULE', '(1280) - LiftBarracks', '(1260) - BuildBarracksTechLab', '(1300) - LiftStarport', '(1380) - LandBarracks', '(15E0) - TrainProbe', '(1541) - BuildPylon', '(1543) - BuildGateway', '(1542) - BuildAssimilator', '(22A0) - CancelLast', '(13E1) - TrainReaper', '(154E) - BuildCyberneticsCore', '(1586) - TrainAdept', '(2720) - TrainMothershipCore', '(1D86) - ResearchWarpGate', '(154D) - BuildRoboticsFacility', '(14A0) - ResearchStimpack', '(13A0) - LowerSupplyDepot', '(4C1) - Patrol', '(1160) - ScannerSweep', '(15C0) - TrainWarpPrism', '(154C) - BuildRoboticsBay', '(4B80) - AdeptPhaseShift', '(E80) - ChronoBoost', '(12E0) - BuildStarportTechLab', '(13C0) - RaiseSupplyDepot', '(16A2) - ResearchGraviticDrive', '(F60) - CancelLast', '(3040) - BurrowWidowMine', '(1C80) - TransformToWarpGate', '(1544) - BuildForge', '(3480) - MothershipCorePurifyNexus', '(15D2) - TrainDisruptor', '(1AC6) - TrainAdept', '(1540) - BuildNexus', '(1546) - BuildTwilightCouncil', '(1680) - UpgradeGroundWeapons1', '(1563) - UnloadUnitWarpPrism', '(4120) - PurificationNovaTargeted', '(1025) - BuildMissileTurret', '(1AC1) - WarpInStalker', '(1442) - UpgradeTerranInfantryWeapons1', '(1562) - UnloadTargetWarpPrism', '(15C2) - TrainColossus', '(1DA1) - ResearchBlink', '(1220) - LiftCommandCenter', '(1240) - LandCommandCenter', '(15C1) - TrainObserver', '(1820) - MorphDrone', '(16E3) - BuildSpawningPool', '(1822) - MorphOverlord', '(1E60) - TrainQueen', '(1821) - MorphZergling', '(1581) - TrainStalker', '(17C1) - EvolveMetabolicBoost', '(16E0) - BuildHatchery', '(DE0) - SpawnLarva', '(4C2) - HoldPosition', '(16ED) - BuildRoachWarren', '(15A8) - TrainOracle', '(16E4) - BuildEvolutionChamber', '(16EF) - BuildSporeCrawler', '(2080) - CreepTumor', '(2120) - BuildCreepTumor', '(1740) - UpgradeToLair', '(1D80) - UpgradeAirWeapons1', '(1726) - ResearchZergMissileWeaponsLevel1', '(16E2) - BuildExtractor', '(4AE0) - BuildOracleStasisTrap', '(43E0) - PrismaticAlignment', '(15A4) - TrainVoidRay', '(16E5) - BuildHydraliskDen', '(1545) - BuildFleetBeacon', '(1723) - ResearchZergGroundArmorsLevel1', '(17E1) - ResearchEvolveMuscularAugments', '(1823) - MorphHydralisk', '(3380) - Revelation', '(1547) - BuildPhotonCannon', '(F00) - Gather', '(31A0) - MedivacSpeedBoost', '(1143) - UnloadUnitMedivac', '(1426) - TrainLiberator', '(13E3) - TrainMarauder', '(1142) - UnloadTargetMedivac', '(1B40) - Blink', '(154A) - BuildTemplarArchive', '(1683) - UpgradeGroundArmor1', '(15C3) - TrainImmortal', '(12C0) - LiftFactory', '(1320) - LandFactory', '(1405) - BuildHellion', '(1340) - LandStarport', '(1421) - TrainBanshee', '(14E0) - ResearchCloakingField', '(FE0) - CancelBuilding', '(1580) - TrainZealot', '(1549) - BuildStargate', '(1D81) - UpgradeAirWeapons2', '(F80) - CancelLast', '(1026) - BuildBunker', '(1DA0) - ResearchCharge', '(12A1) - BuildFactoryReactor', '(15A0) - TrainPhoenix', '(17A1) - EvolvePneumatizedCarapace', '(F81) - CancelSlot', '(1829) - MorphRoach', '(16EE) - BuildSpineCrawler', '(D61) - EvolveGlialReconstitution', '(102D) - BuildArmory', '(1720) - ResearchZergMeleeWeaponsLevel1', '(2060) - GenerateCreep', '(3160) - UpgradeToLurkerDenMP', '(1BA0) - MorphToOverseer', '(1525) - UpgradeVehicleWeapons1', '(1701) - ReturnCargo', '(F01) - ReturnCargo', '(EE1) - ReturnCargo', '(102F) - BuildFusionCore', '(154B) - BuildDarkShrine', '(12BE)', '(1AC4) - WarpInDarkTemplar', '(4C60) - LiberatorAGTarget', '(1422) - TrainRaven', '(1CC0) - LiftOrbitalCommand', '(11E1) - UnloadAllBunker', '(1424) - TrainViking', '(1440) - ResearchHiSecAutoTracking', '(16E8) - BuildInfestationPit', '(1204) - LoadAllCommandCenter', '(1201) - UnloadAllCommandCenter', '(3060) - UnburrowWidowMine', '(42C0) - OracleWeapon', '(16EA) - BuildBanelingNest', '(920) - TrainBaneling', '(16E6) - BuildSpire', '(4EC0) - AdeptShadePhaseShiftCancel', '(103E) - CancelTerranBuilding', '(1DA2) - ResearchAdeptPiercingAttack', '(1D40) - TransportMode', '(40A0) - RavagerCorrosiveBile', '(4020) - MorphToRavager', '(4C80) - LiberatorAATarget', '(12E1) - BuildStarportReactor', '(1C00) - EvolveCentrifugalHooks', '(14A1) - ResearchCombatShield', '(2C80) - BattleMode', '(22A1) - CancelSlot', '(4C3) - ScanMove', '(7E0) - SalvageShared', '(1100) - TankMode', '(42C1) - OracleWeaponOff', '(D41) - SetWorkerRally', '(D40) - SetUnitRally', '(CC0) - SetRallyPoint', '(14A2) - ResearchConcussiveShells', '(1060) - UseStimpack', '(1407) - TrainCyclone', '(1AC0) - WarpInZealot', '(1D20) - PhasingMode', '(1AC3) - WarpInHighTemplar', '(1CE0) - LandOrbitalCommand', '(1824) - MorphMutalisk', '(20A0) - UprootSpineCrawler', '(20E0) - RootSpineCrawler', '(152E) - ResearchTerranVehicleAndShipArmorsLevel1', '(D20) - SetWorkerRally', '(F40) - CancelLast', '(1EA0) - QueenTransfusion', '(2160) - ArchonWarpSelection', '(1AC5) - WarpInSentry', '(1585) - TrainSentry', '(1721) - ResearchZergMeleeWeaponsLevel2', '(BE0) - SpawnChangeling', '(4160) - LockOn', '(15A2) - TrainCarrier', '(1BC0) - UpgradeToPlanetaryFortress', '(5640) - MorphToTransportOverlord', '(1A62) - UnloadTargetOverlord', '(127E)', '(1120) - CloakBanshee', '(14E9) - ResearchBansheeSpeed', '(1121) - DecloakBanshee', '(2140) - BuildAutoTurret', '(14ED) - ResearchRavenRecalibratedExplosives', '(4EA0) - AdeptPhaseShiftCancel', '(12FE)', '(14C1) - ResearchInfernalPreIgniter', '(A40) - HallucinatePhoenix', '(1681) - UpgradeGroundWeapons2', '(16A5) - ResearchExtendedThermalLance', '(17A3) - EvolveBurrow', '(1D00) - ForceField', '(39A0) - TemporalField', '(2100) - RootSporeCrawler', '(1443) - UpgradeTerranInfantryWeapons2', '(1686) - UpgradeShields1', '(1404) - BuildThor', '(213E)', '(900) - MULERepair', '(14E3) - ResearchCorvidReactor', '(2B00) - MassRecallMothershipCore', '(1500) - ResearchPersonalCloaking', '(13E2) - TrainGhost', '(20E1) - CancelRootSpineCrawler', '(1C61) - CancelUpgradeToOrbitalCommand', '(1724) - ResearchZergGroundArmorsLevel2', '(1FC0) - Attack', '(1583) - TrainHighTemplar', '(5700) - ResearchDarkTemplarBlinkUpgrade', '(FE1) - HaltBuilding', '(FC0) - CancelLast', '(11E3) - UnloadUnitBunker', '(182B) - MorphCorruptor', '(16E9) - BuildNydusNetwork', '(1960) - BurrowZergling', '(1028) - BuildSensorTower', '(B60) - GravitonBeam', '(1029) - BuildGhostAcademy', '(D62) - EvolveTunnelingClaws', '(20C0) - UprootSporeCrawler', '(14C4) - ResearchDrillingClaws', '(1741) - CancelUpgradeToLair', '(11A0) - AssaultMode', '(11C0) - FighterMode', '(D00) - SetWorkerRally', '(1727) - ResearchZergMissileWeaponsLevel2', '(16C4) - ResearchPsiStormTech', '(880) - Explode', '(1687) - UpgradeShields2', '(8E0) - GuardianShield', '(1526) - UpgradeVehicleWeapons2', '(780) - SprayTerran', '(1A63) - UnloadUnitOverlord', '(182E) - MorphSwarmHost', '(1BE2) - EvolvePathogenGlands', '(1441) - UpgradeStructureArmor', '(1760) - UpgradeToHive', '(8A0) - ResearchFluxVanes', '(4C0) - Move', '(2DE0) - Attack', '(1700) - Gather', '(1800) - EvolveFlyerAttacks1', '(1447) - UpgradeTerranInfantryArmor2', '(1684) - UpgradeGroundArmor2', '(2180) - BuildNydusCanal', '(42A1) - UnloadAll', '(3180) - HallucinateOracle', '(55E0) - SpawnLocustsTargeted', '(2DA0) - UnburrowSwarmHost', '(FC1) - CancelSlot', '(1406) - BuildBattleHellion', '(EE0) - Gather', '(2B40) - StrikeMode', '(F41) - CancelSlot', '(1203) - UnloadUnitCommandCenter', '(1D83) - UpgradeAirArmor1', '(7C0) - SprayProtoss', '(1423) - TrainBattlecruiser', '(41E0) - Hyperjump', '(1180) - YamatoGun', '(15A9) - TrainTempest', '(1D60) - ResearchWeaponRefit', '(2F60) - DisableVolatileBurst', '(1780) - MorphToGreaterSpire', '(1840) - MorphToBroodLord', '(4220) - ThorAPMode', '(152B) - UpgradeShipWeapons1', '(14EE) - ResearchMedivacIncreaseSpeedBoost', '(1445) - ResearchNeosteelFrame', '(26C0) - UpgradeToMothership', '(18E0) - BurrowHydralisk', '(1AE0) - BurrowQueen', '(1B00) - UnburrowQueen', '(1900) - UnburrowHydralisk', '(E00) - UseStimpack', '(14EF) - ResearchLiberatorAGRangeUpgrade', '(1BA1) - CancelMorphToOverseer', '(1B21) - UnloadAllNydus', '(1803) - EvolveFlyerCarapace1', '(1920) - BurrowRoach', '(1080) - CloakGhost', '(1081) - DecloakGhost', '(2040) - StopRedirect', '(1480) - TrainNuke', '(182A) - MorphInfestor', '(22C1) - CancelSlot', '(16A1) - ResearchGraviticBoosters', '(5641) - Cancel', '(B20) - SeekerMissile', '(1B23) - UnloadUnitNydus', '(1140) - LoadTargetMedivac', '(4021) - Cancel', '(1CA0) - TransformToGateway', '(5600) - VoidRaySwarmDamageBoostCancel', '(B61) - CancelGravitonBeam', '(1584) - TrainDarkTemplar', '(1980) - UnburrowZergling', '(1860) - BurrowBaneling', '(7A0) - SprayZerg', '(3120) - BurrowLurker', '(8A2) - ResearchAnionPulseCrystals', '(4040) - MorphToLurker', '(16E7) - BuildUltraliskCavern', '(EA2) - EvolveChitinousPlating', '(1826) - MorphUltralisk', '(3140) - UnburrowLurker', '(56A0) - ChannelSnipe', '(B01) - ReturnCargo', '(1BC1) - CancelUpgradeToPlanetaryFortress', '(483) - Dance', '(18C0) - UnburrowDrone', '(4380) - LocustMPFlyingSwoop', '(3161) - Cancel', '(41A0) - LockOnCancel', '(9A0) - BuildPointDefenseDrone', '(A80) - HallucinateStalker', '(2D80) - BurrowSwarmHost', '(18A0) - BurrowDrone', '(960) - Feedback', '(4240) - ThorNormalMode', '(3FC0) - CausticSpray', '(26C1) - CancelUpgradeToMothership', '(1E20) - EMPRound', '(1761) - CancelUpgradeToHive', '(1940) - UnburrowRoach', '(2101) - Cancel', '(1B60) - BurrowInfestor', '(1DC0) - TacticalNukeStrike', '(10C0) - HealMedivac', '(1880) - UnburrowBaneling', '(9E0) - HallucinateColossus', '(42A3)', '(1660) - TrainInterceptor', '(820) - HoldFireGhost', '(840) - GWeaponsFreeGhost', '(1FE0) - StimpackRedirect', '(2061) - StopGenerateCreep', '(AC0) - HallucinateWarpPrism', '(152C) - UpgradeShipWeapons2', '(1560) - LoadTarget', '(1801) - EvolveFlyerAttacks2', '(17C0) - EvolveAdrenalGlands', '(AA0) - HallucinateVoidRay', '(4AFE)', '(11E0) - LoadTargetBunker', '(2240) - Contaminate', '(1682) - UpgradeGroundWeapons3', '(2F61) - EnableVolatileBurst', '(40C0) - BurrowRavagerDown', '(40E0) - BurrowRavagerUp', '(1A60) - LoadTargetOverlord', '(B00) - Gather', '(152F) - ResearchTerranVehicleAndShipArmorsLevel2', '(22C0) - CancelLast', '(5560) - DarkTemplarBlink', '(1600) - PsionicStorm', '(AE0) - HallucinateZealot', '(1BE3) - EvolveNeuralParasite', '(4041) - Cancel', '(9C0) - HallucinateArchon', '(DA0) - SpawnInfestedTerran']
    ability_set = set(abilities)

    def init(self):
        self.counts = {
            0: {ability: 0 for ability in AbilityCounts.abilities},
            1: {ability: 0 for ability in AbilityCounts.abilities},
        }

    def update(self, game_id, time, player, species, event, event_contents):
        if event == 'Ability':
            contents = AbilityCounts.parse_contents(event_contents)
            ability = contents[0]
            if ability in AbilityCounts.ability_set:
                self.counts[player][ability] += 1

    def to_dict(self):
        p0_counts = {f'p0_ability_{ability}': self.counts[0][ability] for ability in AbilityCounts.abilities}
        p1_counts = {f'p1_ability_{ability}': self.counts[1][ability] for ability in AbilityCounts.abilities}
        delta_counts = {f'delta_ability_{ability}': self.counts[0][ability] - self.counts[1][ability] for ability in AbilityCounts.abilities}
        return {**p0_counts, **p1_counts, **delta_counts}

    @staticmethod
    def parse_contents(event_contents):
        contents = event_contents.split(';')
        return contents
